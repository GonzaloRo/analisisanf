<div id="content-wrapper">
        <div class="container-fluid">
        <!-- Breadcrumbs-->
                <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/contabilidad_general/transaccion">
                            Transacción
                            </a>
                        </li>
                        <li class="breadcrumb-item active">Modificar | Agregar transacción</li>
                </ol>
                <!-- DataTables Example -->
                <div class="card mb-3">
                        <div class="card-header">
                                <i class="fas fa-edit"></i>
                                Edición | Creación
                                <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="card-body" id="1">
                                <div class="row">
                                        <div class="col-lg-6 col-xs-12 border rounded">
                                                <form name="transaccion_form" novalidate>
                                                        <h4 class="mb-3 text-center header_id">TRANSACCION</h4>
                                                        <div class="form-group">
                                                                <a>Seleccione el tipo de transacción:</a>
                                                                <select id="id_tipo_transaccion" class="form-control" name="select">
                                                                        {{#each tipo_transaccion}}
                                                                        <option value="{{CODIGO_TIPO_TRANSACCION}}">{{NOMBRE_TIPO_TRANSACCION}}</option> 
                                                                        {{else}}
                                                                        <option value="0" selected>---------------</option>
                                                                        {{/each}}
                                                                </select>
                                                        </div>
                                                        <div class="form-group">
                                                                <a>Fecha en que se realiza:</a>
                                                                <input name="fecha" class="form-control" data-date-format="yyyy/mm/dd" id="datepicker">
                                                                {{> fecha }}
                                                        </div>
                                                        <div class="form-group">
                                                                <a>Ingrese el monto:</a>
                                                                <input id="id_monto_transaccion" type="number" name="monto" class="form-control" placeholder="Monto">
                                                        </div>
                                                        <div class="form-group">
                                                                <a>Ingrese descripcion de transacción:</a>
                                                                <textarea id="id_descripcion_transaccion" type="text" name="descripcion" class="form-control" placeholder="Descripcion"></textarea>
                                                        </div>
                                                </form>
                                        </div>
                                        <div  class="col-lg-6 col-xs-12 border rounded">
                                                <form name="movimiento_form" novalidate>
                                                        <h4 class="mb-3 text-center header_id">MOVIMIENTOS</h4>
                                                        <div class="form-group">
                                                            <a>Seleccione cuenta mayor a afectar:</a>
                                                            <select id="cuenta" class="form-control" name="cuenta_padre">
                                                                {{#each cuenta_padre}}
                                                                <option value="{{ID_CUENTA}}">{{NOMBRE_CUENTA}}</option> 
                                                                {{else}}
                                                                <option value="0">-----------------</option>
                                                                {{/each}}
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <a>Seleccione subcuenta a afectar:</a>
                                                            <select id="sub_cuenta" class="form-control" name="sub_cuenta" >
                                                                {{#each subcuenta}}
                                                                <option value="{{ID_CUENTA}}">{{NOMBRE_CUENTA}}</option> 
                                                                {{else}}
                                                                <option value="0">-----------------</option>
                                                                {{/each}}
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <a>Seleccione subcuenta menor a afectar:</a>
                                                            <select id="sub_sub_cuenta" class="form-control" name="sub_sub_cuenta">
                                                                {{#each sub_subcuenta}}
                                                                <option value="{{ID_CUENTA}}" >{{NOMBRE_CUENTA}}</option> 
                                                                {{else}}
                                                                <option value="0">-----------------</option>
                                                                {{/each}}
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                                <a>Ingrese el monto de la cuenta:</a>
                                                                <input id="monto_movimiento" type="number" name="monto" class="form-control" placeholder="Monto">
                                                        </div>
                                                        <div class="form-group">
                                                                <input type="checkbox" id="cb_abonar" value="second_checkbox" onclick=""> 
                                                                <label for="cbox2">Abonar</label>
                                                                <input type="checkbox" id="cb_cargar" value="second_checkbox" onclick=""> 
                                                                <label for="cbox2">Cargar</label>
                                                        </div>
                                                        <div class="col-12 text-center" style="padding-bottom: 5%">    
                                                                <button class="btn btn-outline-primary btn-plus" onclick="obtenerDatos()" type="button">
                                                                        Registrar movimiento  
                                                                        <i class="fas fa-plus-circle"></i>
                                                                </button>
                                                        </div>
                                                </form>
                                        </div>
                                </div>
                        </div>
                </div> 
                <div class="card mb-3">
                        <div class="card-header">
                                <i class="fas fa-table"></i>
                                Movimientos
                        </div>
                        <div class="card-body">
                                <div class="table-responsive">
                                        <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                                                <thead>
                                                        <tr>
                                                                <th class="text-center">#</th>
                                                                <th class="text-center">Cuenta</th>                
                                                                <th class="text-center">Debe</th>
                                                                <th class="text-center">Haber</th>
                                                        </tr>
                                                </thead>
                                                <tbody id="tbBody">                                                
                                                </tbody>
                                                <tfoot>
                                                <tr>
                                                        <th colspan="2" class="text-right">Comprobacion</th>
                                                        <th class="text-center" id="debe">$ 0.00</th>
                                                        <th class="text-center" id="haber">$ 0.00</th>
                                                </tr>
                                                </tfoot>
                                        </table>
                                </div>
                        </div>
                </div>     
        </div>
        <div class="form-group text-center">
                <button id='aprobar' type="submit" onclick="guardarDato()" class='btn btn-primary' style="width: 30%" href='#'>Guardar</button>
                <button class='btn btn-secondary' style="width: 30%" type='button'>Cancelar</button>         
                <br>     
                <br>     
        </div>
</div>
    <script type="text/javascript">
        //Declaracion de variables
        var count = 0;
        var totalCargos = 0;
        var totalAbonos = 0;
        var codigo_cuentas = "";
        var cargos = "";
        var abonos = "";
        var codigoTipo = null;
        var monto = null;
        var descripcion = null;

        //Validad que solo un chechbox este seleccionado
        /*function check1(checkbox) {
                if (checkbox.checked) {
                    check2.checked = false;
                }
            }

            function check2(checkbox) {
                if (checkbox.checked) {
                    check1.checked = false;
                }
            }*/
            
        function obtenerDatos(){
            console.log("agregarFila")
            count = count + 1;
            var codigoCuenta = $("#cuenta").val();
            var codigoSubCuenta = $("#sub_cuenta").val();
            var codigoSubSubCuenta = $("#sub_sub_cuenta").val();

            var cbCuenta = document.getElementById("cuenta");
            var cbSubCuenta = document.getElementById("sub_cuenta");
            var cbSubSubCuenta = document.getElementById("sub_sub_cuenta");
                
            var cuenta = cbCuenta.options[cbCuenta.selectedIndex].text;
            var subCuenta = cbSubCuenta.options[cbSubCuenta.selectedIndex].text;
            var subSubCuenta = cbSubSubCuenta.options[cbSubSubCuenta.selectedIndex].text;
                
            var monto_mov = parseFloat($("#monto_movimiento").val());
            var abonar = document.getElementById('cb_abonar').checked;
            $(".dataTables_empty").remove();

            var correcto = false;
            
            if(!isNaN(monto_mov) && abonar==false){//si es un numero NAN devuelve true --> !(devuelve false)=true
                if(cuenta!='' && cuenta!='---------------' && subCuenta=='---------------'){
                    agregarFila(codigoCuenta, cuenta, monto_mov, abonar);
                    correcto = true;
                }else{
                    if(subCuenta!='' && subCuenta!='---------------' && subSubCuenta=='---------------'){
                        agregarFila(codigoSubCuenta, subCuenta, monto_mov, abonar);
                        correcto = true;
                    }else{
                        if(subSubCuenta!='' && subSubCuenta!='---------------'){
                            agregarFila(codigoSubSubCuenta, subSubCuenta, monto_mov, abonar);
                            correcto = true;
                        }
                    }
                }
            }else{
                if(!isNaN(monto_mov) && abonar==true){
                    if(cuenta!='' && cuenta!='---------------' && subCuenta=='---------------'){
                        agregarFila(codigoCuenta, cuenta, monto_mov, abonar);
                        correcto = true;
                    }else{
                        if(subCuenta!='' && subCuenta!='---------------' && subSubCuenta=='---------------'){
                            agregarFila(codigoSubCuenta, subCuenta, monto_mov, abonar);
                            correcto = true;
                        }else{
                            if(subSubCuenta!='' && subSubCuenta!='---------------'){
                                agregarFila(codigoSubSubCuenta, subSubCuenta, monto_mov, abonar);
                                correcto = true;
                            }
                        }
                    }
                }
            }
            if(correcto==true){
                $("#monto_mov").val("")
            }else{
                console.log("Correcto: "+correcto);
                alerta_error();
            }
        }
        function alerta_error(){
            alert("Oops... Falta completar o seleccionar algunos campos");
            /*Swal.fire({
                type: 'error',
                title: 'Oops...',
                text: 'Something went wrong!',
                footer: '<a href>Why do I have this issue?</a>'
                });*/
        }

        function agregarFila(codigoSubCuenta, cuenta, monto_mov, abonar){
            if(abonar==false){
                //codigo_cuentas+=codigoSubCuenta+",";
                codigo_cuentas+=codigoSubCuenta+",";
                cargos+=monto_mov+",";
                abonos+="0,";
                totalCargos = totalCargos + monto_mov;

                console.log("CARGO")
                $("#tbBody").append(
                    "<tr><td class='text-center'>"+count+"</td>"+
                    "<td>"+cuenta+"</td>"+
                    "<td class='text-center'>$ "+monto_mov+"</td><td></td></tr>"
                );
                $("#debe").empty();
                $("#debe").append("$ "+totalCargos);
            };
            if(abonar==true){
                codigo_cuentas+=codigoSubCuenta+",";
                abonos+=monto_mov+",";
                cargos+="0,";
                totalAbonos = totalAbonos + monto_mov;                

                console.log("ABONO")
                $("#tbBody").append(
                    "<tr><td class='text-center'>"+count+"</td>"+
                    "<td>"+cuenta+"</td>"+
                    "<td></td><td class='text-center'>$ "+monto_mov+"</td></tr>"
                );
                $("#haber").empty();
                $("#haber").append("$ "+totalAbonos);
            }
        };
        
        function guardarDato(){
            codigoTipo = $("#id_tipo_transaccion").val();
            cbTipo = document.getElementById("id_tipo_transaccion");
            tipo = cbTipo.options[cbTipo.selectedIndex].text;
            monto = parseFloat($("#id_monto_transaccion").val());
            descripcion = $("#id_descripcion_transaccion").val();
            fecha = $("#datepicker").val();
            //console.log(fecha);

            if(tipo!='' && tipo!='---------' && !isNaN(monto) && descripcion!=''){
                if(totalAbonos==totalCargos){
                    if(totalAbonos==monto){
                        //console.log("Cuentas: "+codigo_cuentas+"\nAbonos: "+abonos+"\nCargos: "+cargos);
                        $.ajax({
                            url: "/contabilidad_general/transaccion/agregar_transaccion",
                            type: "POST",
                            data: {
                                'ID_CUENTA': codigo_cuentas,
                                'MONTO_CARGO': cargos,
                                'MONTO_ABONO': abonos,
                                'CODIGO_TIPO_TRANSACCION': codigoTipo,
                                'MONTO_TRANSACCION': monto,
                                'DESCRIPCION_TRANSACCION': descripcion,
                                'FECHA_TRANSACCION': fecha,
                                'count' : count
                            },
                            success: function(data){
                                console.log(data);
                                console.log("SUCCESS");
                            },
                            dataType: "json"
                        }).done(function(data){
                            location.href = data.success_url;
                        }).fail(function() {
                            console.log("error");
                            alert("La transaccion no pudo ser realizada");
                        }).always(function() {
                            console.log("complete");
                        });
                    }else{
                        alert("!Datos incoherentes! El monto de la partida doble no concuerda con el monto de la transaccion. Presione Aceptar");
                    }
                }else{
                    alert("!Error en partida doble! Los movimientos registrados para esta transacción no cumplen partida doble. Presione Aceptar");
                }
            }else{
                alert("!Error! Datos incompletos. Verifique que los campos de la Transacción estén completos. Presione Aceptar");
            }
        }
    </script>



